EBIN_DIR=ebin
SOURCE_DIR=src
INCLUDE_DIR=include
ERLC_FLAGS=-W0 -Ddebug +debug_info
ERLC=erlc -I $(INCLUDE_DIR) -o $(EBIN_DIR) $(ERLC_FLAGS) $(SOURCE_DIR)
ERL=erl -I -pa ebin -noshell -eval
PARSER_BASE_NAME=selector
LEXER_NAME=$(PARSER_BASE_NAME)_lexer
PARSER_NAME=$(PARSER_BASE_NAME)_parser
LEXER_TEST_NAME=lexer
PARSER_TEST_NAME=parser

compile:
	mkdir -p $(EBIN_DIR)
	# Compile the lexer generator because it is not part of OTP
	$(ERLC)/leex.erl
	# Generate the lexer
	# $(ERL) 'leex:file("$(SOURCE_DIR)/$(LEXER_NAME)",[{outdir,"$(SOURCE_DIR)"}]), halt().'
	$(ERL) 'leex:file("$(SOURCE_DIR)/$(LEXER_TEST_NAME)",[{outdir,"$(SOURCE_DIR)"}]), halt().'
	# Generate the parser
	# $(ERL) 'yecc:file("$(SOURCE_DIR)/$(PARSER_NAME)"), halt().'
	$(ERL) 'yecc:file("$(SOURCE_DIR)/$(PARSER_TEST_NAME)"), halt().'
	# Compile everything
	$(ERLC)/*.erl

all: compile

test: compile
	$(ERL) 'selector_test:test(), halt().'

clean:
	rm $(SOURCE_DIR)/$(LEXER_NAME).erl
	rm $(SOURCE_DIR)/$(PARSER_NAME).erl
	rm $(EBIN_DIR)/*.beam
